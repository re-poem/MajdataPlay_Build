name: Generate Hashes JSON

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  generate-hashes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate hashes.json
        run: |
          OUTPUT_FILE="hashes.json"
          HASHES_JSON="[]"

          # å®‰å…¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼Œç”¨äº JSON å­—ç¬¦ä¸²
          json_escape() {
            printf '%s' "$1" | sed 's|\\|\\\\|g; s|"|\\"|g; s|\n|\\n|g; s|\r|\\r|g; s|\t|\\t|g'
          }

          # æŸ¥æ‰¾æ‰€æœ‰æ™®é€šæ–‡ä»¶ï¼Œæ’é™¤ .git, .github å’Œ hashes.json æœ¬èº«
          find . -type f \
            ! -path './.git/*' \
            ! -path './.github/*' \
            ! -path "./$OUTPUT_FILE" \
            | sort | while read file; do

            # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ ./ å‰ç¼€ï¼‰
            rel_path="${file#./}"
            filename="$(basename "$file")"
            sha256=$(sha256sum "$file" | awk '{print $1}')

            # æ„å»º JSON å¯¹è±¡ï¼Œå®‰å…¨è½¬ä¹‰å­—æ®µ
            entry="{
              \"Name\": \"$(json_escape "$filename")\",
              \"SHA256\": \"$sha256\",
              \"RelativePath\": \"$(json_escape "$rel_path")\"
            }"

            # ä½¿ç”¨ jq å°†å¯¹è±¡æ·»åŠ åˆ°æ•°ç»„
            HASHES_JSON=$(echo "$HASHES_JSON" | jq --argjson item "$entry" '. += [$item]')
          done

          # æ ¼å¼åŒ–è¾“å‡ºåˆ°æ–‡ä»¶
          echo "$HASHES_JSON" | jq '.' > "$OUTPUT_FILE"
          echo "âœ… Generated $OUTPUT_FILE with $(jq '. | length' "$OUTPUT_FILE") file(s)."

      - name: Display hashes.json
        run: cat hashes.json

      - name: Commit and push if hashes.json changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add hashes.json

          # ä»…å½“æœ‰å˜æ›´æ—¶æäº¤
          if ! git diff --cached --quiet; then
            git commit -m "chore: update hashes.json for tag ${{ github.ref_name }}"
            git push
            echo "ğŸ“Œ hashes.json updated and pushed."
          else
            echo "ğŸŸ¢ hashes.json unchanged, nothing to commit."
          fi